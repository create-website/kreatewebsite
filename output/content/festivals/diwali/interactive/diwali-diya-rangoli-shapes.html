<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Virtual Diwali Celebration: Light a Diya & Create a Rangoli</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@300;400;500;600;700&family=Tiro+Devanagari+Hindi:ital@0;1&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Hind Siliguri', sans-serif;
            background: linear-gradient(135deg, #4c0519, #7a0c2f, #2d0d30, #0c0a24);
            overflow-x: hidden;
        }
        .diya-canvas, .rangoli-canvas {
            cursor: crosshair;
            touch-action: none;
        }
        .font-devanagari {
            font-family: 'Tiro Devanagari Hindi', serif;
        }
        .color-palette button:hover, .color-palette button.active,
        .diya-color-btn:hover, .diya-color-btn.active {
            transform: scale(1.15);
            box-shadow: 0 0 15px currentColor;
        }
        .diya-color-btn.active {
            border-color: white;
        }
        .shape-btn.active {
            @apply bg-amber-600 border-amber-400;
        }
        .btn-primary {
            @apply bg-amber-500 text-red-900 font-bold py-2 px-6 rounded-lg shadow-lg transition-transform transform hover:scale-105 hover:bg-amber-400 focus:outline-none focus:ring-4 focus:ring-amber-300;
        }
        .modal {
            @apply fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 transition-opacity duration-300;
        }
        .modal-content {
            @apply bg-white p-6 rounded-2xl shadow-2xl text-center max-w-sm w-full mx-4;
        }
        .animate-flicker {
             animation: flicker 1.5s infinite alternate;
        }
        @keyframes flicker {
            0%, 18%, 22%, 25%, 53%, 57%, 100% {
                box-shadow:
                0 0 4px #fff,
                0 0 11px #fff,
                0 0 19px #fff,
                0 0 40px #ff0,
                0 0 80px #ff0,
                0 0 90px #ff0,
                0 0 100px #ff0,
                0 0 150px #ff0;
            }
            20%, 24%, 55% {
                box-shadow: none;
            }
        }
    </style>
</head>
<body class="text-white min-h-screen flex flex-col items-center justify-center p-4">

    <!-- Header -->
    <header class="text-center mb-8">
        <h1 class="font-devanagari text-5xl md:text-7xl font-bold text-amber-400" style="text-shadow: 0 0 10px #f59e0b;">शुभ दीपावली</h1>
        <p class="text-xl md:text-2xl text-amber-100 mt-2">Virtual Diwali Celebration</p>
    </header>

    <!-- Main Creator View -->
    <div id="creator-view" class="w-full max-w-6xl mx-auto grid grid-cols-1 lg:grid-cols-2 gap-8">

        <!-- Diya Section -->
        <section id="diya-section" class="bg-black bg-opacity-30 p-6 rounded-2xl shadow-xl flex flex-col items-center justify-between">
            <h2 class="text-3xl font-semibold text-amber-300 mb-4">Light a Virtual Diya</h2>
            <div class="relative w-full max-w-sm h-64 flex items-center justify-center">
                <canvas id="diyaCanvas" class="diya-canvas w-full h-full"></canvas>
            </div>
            <!-- Diya Customization Controls -->
            <div class="w-full max-w-sm mt-4 space-y-4 text-amber-100">
                <div class="flex items-center justify-between">
                    <label for="diyaColor" class="text-amber-100">Diya Color:</label>
                    <div id="diyaColorPalette" class="flex items-center gap-2">
                        <button class="diya-color-btn w-6 h-6 rounded-full border-2 border-transparent transition-transform" style="background-color: #ef4444;" data-color="#ef4444" title="Red"></button>
                        <button class="diya-color-btn w-6 h-6 rounded-full border-2 border-transparent transition-transform" style="background-color: #f97316;" data-color="#f97316" title="Orange"></button>
                        <button class="diya-color-btn w-6 h-6 rounded-full border-2 border-transparent transition-transform" style="background-color: #facc15;" data-color="#facc15" title="Yellow"></button>
                        <button class="diya-color-btn w-6 h-6 rounded-full border-2 border-transparent transition-transform" style="background-color: #3b82f6;" data-color="#3b82f6" title="Blue"></button>
                        <button class="diya-color-btn w-6 h-6 rounded-full border-2 border-transparent transition-transform active" style="background-color: #E59866;" data-color="#E59866" title="Terracotta"></button>
                        <input type="color" id="diyaColor" value="#E59866" class="w-8 h-8 p-0 bg-transparent border-none rounded-full cursor-pointer [&::-webkit-color-swatch-wrapper]:p-0 [&::-webkit-color-swatch]:rounded-full [&::-webkit-color-swatch]:border-none" title="Other">
                    </div>
                </div>
                <div class="flex items-center justify-between">
                    <label for="diyaSize">Diya Size:</label>
                    <input type="range" id="diyaSize" min="0.5" max="1.5" value="1" step="0.1" class="w-1/2">
                </div>
                <div>
                    <label class="block mb-2 text-center">Diya Shape:</label>
                    <div class="flex justify-center flex-wrap gap-2">
                        <button class="shape-btn bg-amber-800 border-2 border-transparent p-2 rounded-lg text-xs" data-shape="classic">Classic</button>
                        <button class="shape-btn bg-amber-800 border-2 border-transparent p-2 rounded-lg text-xs" data-shape="deep-bowl">Deep Bowl</button>
                        <button class="shape-btn bg-amber-800 border-2 border-transparent p-2 rounded-lg text-xs" data-shape="panchmukhi">Panchmukhi</button>
                        <button class="shape-btn bg-amber-800 border-2 border-transparent p-2 rounded-lg text-xs" data-shape="ashtmukhi">Ashtmukhi</button>
                        <button class="shape-btn bg-amber-800 border-2 border-transparent p-2 rounded-lg text-xs" data-shape="leaf">Leaf</button>
                        <button class="shape-btn bg-amber-800 border-2 border-transparent p-2 rounded-lg text-xs" data-shape="lotus">Lotus</button>
                        <button class="shape-btn bg-amber-800 border-2 border-transparent p-2 rounded-lg text-xs" data-shape="kalash">Kalash</button>
                    </div>
                </div>
            </div>
            <div class="flex space-x-4 mt-6">
                <button id="lightDiyaBtn" class="btn-primary">Light the Diya</button>
                <button id="shareDiyaBtn" class="btn-primary" disabled>Share Diya</button>
            </div>
        </section>

        <!-- Rangoli Section -->
        <section id="rangoli-section" class="bg-black bg-opacity-30 p-6 rounded-2xl shadow-xl flex flex-col items-center">
            <h2 class="text-3xl font-semibold text-amber-300 mb-4">Create a Rangoli</h2>
            <div class="w-full max-w-md aspect-square bg-gray-900 rounded-lg shadow-inner overflow-hidden">
                <canvas id="rangoliCanvas" class="rangoli-canvas w-full h-full"></canvas>
            </div>
            <div class="mt-4 w-full max-w-md">
                <!-- Color Palette -->
                <div class="color-palette flex justify-center flex-wrap gap-3 mb-4 p-2 bg-black bg-opacity-20 rounded-lg">
                    <button class="w-8 h-8 rounded-full transition-transform active" style="background-color: #ffffff;"></button>
                    <button class="w-8 h-8 rounded-full transition-transform" style="background-color: #f87171;"></button>
                    <button class="w-8 h-8 rounded-full transition-transform" style="background-color: #fb923c;"></button>
                    <button class="w-8 h-8 rounded-full transition-transform" style="background-color: #facc15;"></button>
                    <button class="w-8 h-8 rounded-full transition-transform" style="background-color: #4ade80;"></button>
                    <button class="w-8 h-8 rounded-full transition-transform" style="background-color: #38bdf8;"></button>
                    <button class="w-8 h-8 rounded-full transition-transform" style="background-color: #a78bfa;"></button>
                    <button class="w-8 h-8 rounded-full transition-transform" style="background-color: #f472b6;"></button>
                </div>
                 <!-- Controls -->
                <div class="flex items-center justify-between mb-4">
                     <label for="brushSize" class="text-amber-100">Brush Size:</label>
                     <input type="range" id="brushSize" min="1" max="20" value="5" class="w-1/2">
                </div>
                <div class="flex space-x-4">
                    <button id="clearRangoliBtn" class="btn-primary w-1/2">Clear</button>
                    <button id="shareRangoliBtn" class="btn-primary w-1/2">Share Rangoli</button>
                </div>
            </div>
        </section>

    </div>

    <!-- Personalized Greeting View (Initially hidden) -->
    <div id="greeting-view" class="hidden w-full max-w-3xl mx-auto bg-black bg-opacity-40 p-8 rounded-2xl shadow-xl text-center">
        <h2 id="greeting-for" class="text-3xl md:text-4xl font-semibold text-amber-300 mb-4">A special greeting for you!</h2>
        <div class="bg-white text-gray-800 p-6 rounded-lg mb-6">
            <p id="greeting-message" class="text-lg md:text-xl"></p>
        </div>
        <img id="greeting-image" src="" alt="Diwali Creation" class="w-full max-w-md mx-auto h-auto rounded-lg border-4 border-amber-400 mb-6">
        <a href="index.html" class="btn-primary inline-block">Create Your Own Greeting!</a>
    </div>


    <!-- Personalized Sharing Modal -->
    <div id="shareModal" class="modal opacity-0 pointer-events-none">
        <div class="modal-content transform scale-95 transition-transform duration-300">
             <h3 class="text-2xl font-bold text-gray-800 mb-4">Share with a Personal Touch</h3>
             
             <img id="sharePreviewImage" src="" alt="Your Creation Preview" class="w-48 h-auto mx-auto rounded-lg border-2 border-amber-400 mb-4">

             <div class="text-left space-y-4">
                <div>
                    <label for="friendName" class="block text-sm font-medium text-gray-700">Friend's Name:</label>
                    <input type="text" id="friendName" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-amber-500 focus:border-amber-500">
                </div>
                <div>
                    <label for="personalMessage" class="block text-sm font-medium text-gray-700">Your Message:</label>
                    <textarea id="personalMessage" rows="3" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-amber-500 focus:border-amber-500" placeholder="Happy Diwali!"></textarea>
                </div>
             </div>
             
             <button id="generateLinkBtn" class="btn-primary w-full mt-6">Generate Link</button>

             <div id="generatedLinkContainer" class="hidden mt-4">
                <p class="text-sm text-gray-600">Your personalized link is ready:</p>
                <div class="mt-1 flex rounded-md shadow-sm">
                    <input type="text" id="generatedLink" readonly class="flex-1 min-w-0 block w-full px-3 py-2 rounded-none rounded-l-md bg-gray-100 border-gray-300 text-sm">
                    <button id="copyLinkBtn" class="inline-flex items-center px-3 rounded-r-md border border-l-0 border-gray-300 bg-gray-200 text-gray-600 hover:bg-gray-300">Copy</button>
                </div>
             </div>

             <button id="closeModalBtn" class="mt-4 text-sm text-gray-500 hover:underline">Close</button>
        </div>
    </div>

    <script>
        // --- Diya Lighting Logic ---
        const diyaCanvas = document.getElementById('diyaCanvas');
        const diyaCtx = diyaCanvas.getContext('2d');
        const lightDiyaBtn = document.getElementById('lightDiyaBtn');
        const shareDiyaBtn = document.getElementById('shareDiyaBtn');
        const diyaColorInput = document.getElementById('diyaColor');
        const diyaColorPalette = document.getElementById('diyaColorPalette');
        const diyaSizeInput = document.getElementById('diyaSize');
        const shapeButtons = document.querySelectorAll('.shape-btn');

        let isLit = false;
        let flameAnimation;
        let diyaColor = '#E59866';
        let diyaSize = 1.0;
        let diyaShape = 'classic';

        function resizeDiyaCanvas() {
            const rect = diyaCanvas.parentElement.getBoundingClientRect();
            diyaCanvas.width = rect.width;
            diyaCanvas.height = rect.height;
            drawDiya();
        }

        function drawDiya() {
            diyaCtx.clearRect(0, 0, diyaCanvas.width, diyaCanvas.height);
            const centerX = diyaCanvas.width / 2;
            const centerY = diyaCanvas.height / 1.5;
            const baseWidth = (diyaCanvas.width / 2.5);
            const baseHeight = (diyaCanvas.height / 5);
            
            const diyaWidth = baseWidth * diyaSize;
            const diyaHeight = baseHeight * diyaSize;

            diyaCtx.fillStyle = diyaColor;
            diyaCtx.strokeStyle = '#D35400';
            diyaCtx.lineWidth = 2;
            
            let flamePoints = [{ x: centerX, y: centerY - diyaHeight / 2 }]; // Default flame point

            switch(diyaShape) {
                case 'deep-bowl': {
                    diyaCtx.beginPath();
                    diyaCtx.moveTo(centerX - diyaWidth / 2, centerY - diyaHeight / 2);
                    diyaCtx.quadraticCurveTo(centerX, centerY + diyaHeight, centerX + diyaWidth / 2, centerY - diyaHeight/2);
                    diyaCtx.closePath();
                    diyaCtx.fill();
                    diyaCtx.stroke();
                    flamePoints = [{ x: centerX, y: centerY - diyaHeight * 0.8 }];
                    break;
                }
                case 'panchmukhi':
                case 'ashtmukhi': {
                    const points = diyaShape === 'panchmukhi' ? 5 : 8;
                    flamePoints = [];
                    const radius = diyaWidth / 2.5;

                    for (let i = 0; i < points; i++) {
                        const angle = (i / points) * Math.PI * 2;
                        const spoutX = centerX + Math.cos(angle) * radius * 1.5;
                        const spoutY = centerY + Math.sin(angle) * radius * 1.5;
                        flamePoints.push({ x: spoutX, y: spoutY });
                        
                        diyaCtx.beginPath();
                        diyaCtx.moveTo(centerX + Math.cos(angle - 0.2) * radius, centerY + Math.sin(angle - 0.2) * radius);
                        diyaCtx.lineTo(spoutX, spoutY);
                        diyaCtx.lineTo(centerX + Math.cos(angle + 0.2) * radius, centerY + Math.sin(angle + 0.2) * radius);
                        diyaCtx.quadraticCurveTo(centerX, centerY, centerX + Math.cos(angle - 0.2) * radius, centerY + Math.sin(angle - 0.2) * radius);
                        diyaCtx.fill();
                        diyaCtx.stroke();
                    }
                     // Central bowl
                    diyaCtx.beginPath();
                    diyaCtx.arc(centerX, centerY, radius, 0, 2 * Math.PI);
                    diyaCtx.fill();
                    diyaCtx.stroke();
                    break;
                }
                 case 'leaf': {
                    diyaCtx.beginPath();
                    diyaCtx.moveTo(centerX, centerY + diyaHeight/2);
                    diyaCtx.bezierCurveTo(centerX - diyaWidth, centerY, centerX - diyaWidth, centerY - diyaHeight * 1.5, centerX, centerY - diyaHeight);
                    diyaCtx.bezierCurveTo(centerX + diyaWidth, centerY - diyaHeight * 1.5, centerX + diyaWidth, centerY, centerX, centerY + diyaHeight/2);
                    diyaCtx.closePath();
                    diyaCtx.fill();
                    diyaCtx.stroke();
                    flamePoints = [{ x: centerX, y: centerY - diyaHeight * 0.8 }];
                    break;
                }
                case 'lotus': {
                     const radius = diyaWidth / 2;
                     // back petals
                    for(let i=0; i < 5; i++) {
                        const angle = (i/5) * Math.PI * 2 + (Math.PI/5);
                        diyaCtx.beginPath();
                        diyaCtx.moveTo(centerX, centerY);
                        diyaCtx.quadraticCurveTo(centerX + Math.cos(angle) * radius * 1.5, centerY + Math.sin(angle) * radius * 1.5, centerX + Math.cos(angle) * radius, centerY + Math.sin(angle) * radius);
                        diyaCtx.quadraticCurveTo(centerX + Math.cos(angle) * radius * 1.2, centerY + Math.sin(angle) * radius * 1.2, centerX, centerY);
                        diyaCtx.fill();
                    }
                     // front petals
                    for(let i=0; i < 5; i++) {
                        const angle = (i/5) * Math.PI * 2;
                        diyaCtx.beginPath();
                        diyaCtx.moveTo(centerX, centerY);
                        diyaCtx.quadraticCurveTo(centerX + Math.cos(angle) * radius * 1.2, centerY + Math.sin(angle) * radius * 1.2, centerX + Math.cos(angle) * radius * 0.8, centerY + Math.sin(angle) * radius * 0.8);
                        diyaCtx.quadraticCurveTo(centerX + Math.cos(angle) * radius, centerY + Math.sin(angle) * radius, centerX, centerY);
                        diyaCtx.fill();
                    }
                    diyaCtx.stroke();
                    flamePoints = [{ x: centerX, y: centerY - diyaHeight / 4 }];
                    break;
                }
                case 'kalash': {
                    diyaCtx.beginPath();
                    const topRadius = diyaWidth / 4;
                    const bottomRadius = diyaWidth / 2;
                    diyaCtx.moveTo(centerX - topRadius, centerY - diyaHeight);
                    diyaCtx.lineTo(centerX + topRadius, centerY - diyaHeight);
                    diyaCtx.bezierCurveTo(centerX + bottomRadius * 1.2, centerY - diyaHeight/2, centerX + bottomRadius, centerY + diyaHeight/2, centerX, centerY + diyaHeight/2);
                    diyaCtx.bezierCurveTo(centerX - bottomRadius, centerY + diyaHeight/2, centerX - bottomRadius * 1.2, centerY - diyaHeight/2, centerX - topRadius, centerY - diyaHeight);
                    diyaCtx.closePath();
                    diyaCtx.fill();
                    diyaCtx.stroke();
                    flamePoints = [{ x: centerX, y: centerY - diyaHeight }];
                    break;
                }
                case 'classic':
                default:
                    diyaCtx.beginPath();
                    diyaCtx.moveTo(centerX - diyaWidth / 2, centerY);
                    diyaCtx.quadraticCurveTo(centerX, centerY + diyaHeight, centerX + diyaWidth / 2, centerY);
                    diyaCtx.quadraticCurveTo(centerX, centerY - diyaHeight / 2, centerX - diyaWidth / 2, centerY);
                    diyaCtx.fill();
                    diyaCtx.stroke();
                    flamePoints = [{ x: centerX, y: centerY - diyaHeight / 2 }];
                    break;
            }
            
            // Oil (drawn only on single-flame diyas for clarity)
            if (flamePoints.length === 1) {
                diyaCtx.beginPath();
                diyaCtx.ellipse(flamePoints[0].x, flamePoints[0].y + diyaHeight/4, diyaWidth / 3, diyaHeight / 5, 0, 0, 2 * Math.PI);
                diyaCtx.fillStyle = '#FAD7A0';
                diyaCtx.fill();
            }

            if (isLit) {
                flamePoints.forEach(point => drawFlame(point.x, point.y));
            }
        }
        
        function drawFlame(x, y) {
            const flickerX = x + (Math.random() - 0.5) * 4;
            const flickerY = y - (Math.random() * 5);
            const flameHeight = diyaCanvas.height / 5 + (Math.random() - 0.5) * 10;
            
            // Outer glow
            diyaCtx.beginPath();
            const glowGradient = diyaCtx.createRadialGradient(flickerX, flickerY, 0, flickerX, flickerY, flameHeight * 0.8);
            glowGradient.addColorStop(0, 'rgba(255, 165, 0, 0.6)');
            glowGradient.addColorStop(1, 'rgba(255, 165, 0, 0)');
            diyaCtx.fillStyle = glowGradient;
            diyaCtx.arc(flickerX, flickerY, flameHeight * 0.8, 0, 2 * Math.PI);
            diyaCtx.fill();

            // Flame
            diyaCtx.beginPath();
            diyaCtx.moveTo(flickerX, flickerY + flameHeight / 4);
            diyaCtx.quadraticCurveTo(flickerX + flameHeight / 5, flickerY - flameHeight / 2, flickerX, flickerY - flameHeight);
            diyaCtx.quadraticCurveTo(flickerX - flameHeight / 5, flickerY - flameHeight / 2, flickerX, flickerY + flameHeight / 4);
            const gradient = diyaCtx.createLinearGradient(flickerX, flickerY, flickerX, flickerY - flameHeight);
            gradient.addColorStop(0, '#FFD700'); // Gold
            gradient.addColorStop(0.5, '#FFA500'); // Orange
            gradient.addColorStop(1, '#FF4500'); // OrangeRed
            diyaCtx.fillStyle = gradient;
            diyaCtx.fill();
        }

        function animateFlame() {
            drawDiya();
            flameAnimation = requestAnimationFrame(animateFlame);
        }

        lightDiyaBtn.addEventListener('click', () => {
            isLit = true;
            if (flameAnimation) cancelAnimationFrame(flameAnimation);
            animateFlame();
            lightDiyaBtn.textContent = 'Relight Diya';
            shareDiyaBtn.disabled = false;
        });

        // --- Diya Customization Event Listeners ---
        diyaColorPalette.addEventListener('click', (e) => {
            if (e.target.classList.contains('diya-color-btn')) {
                const selectedColor = e.target.dataset.color;
                diyaColor = selectedColor;
                diyaColorInput.value = selectedColor; // Sync color picker

                // Update active state
                diyaColorPalette.querySelectorAll('.diya-color-btn').forEach(btn => btn.classList.remove('active'));
                e.target.classList.add('active');

                drawDiya();
            }
        });

        diyaColorInput.addEventListener('input', (e) => {
            diyaColor = e.target.value;
            diyaColorPalette.querySelectorAll('.diya-color-btn').forEach(btn => btn.classList.remove('active'));
            drawDiya();
        });


        diyaSizeInput.addEventListener('input', (e) => {
            diyaSize = parseFloat(e.target.value);
            drawDiya();
        });
        
        shapeButtons.forEach(button => {
            button.addEventListener('click', () => {
                shapeButtons.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                diyaShape = button.dataset.shape;
                drawDiya();
            });
        });
        // Set the default active shape button on load
        document.querySelector('.shape-btn[data-shape="classic"]').classList.add('active');


        // --- Rangoli Drawing Logic ---
        const rangoliCanvas = document.getElementById('rangoliCanvas');
        const rangoliCtx = rangoliCanvas.getContext('2d');
        const colorPalette = document.querySelector('.color-palette');
        const brushSizeInput = document.getElementById('brushSize');
        const clearRangoliBtn = document.getElementById('clearRangoliBtn');
        const shareRangoliBtn = document.getElementById('shareRangoliBtn');

        let isDrawing = false;
        let currentColor = '#ffffff';
        let currentBrushSize = 5;
        const SYMMETRY_POINTS = 8;

        function resizeRangoliCanvas() {
            const rect = rangoliCanvas.parentElement.getBoundingClientRect();
            rangoliCanvas.width = rect.width;
            rangoliCanvas.height = rect.height;
            rangoliCtx.fillStyle = '#111827'; // bg-gray-900
            rangoliCtx.fillRect(0,0,rangoliCanvas.width, rangoliCanvas.height);
        }
        
        function getMousePos(canvas, evt) {
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            const clientX = evt.touches ? evt.touches[0].clientX : evt.clientX;
            const clientY = evt.touches ? evt.touches[0].clientY : evt.clientY;

            return {
                x: (clientX - rect.left) * scaleX,
                y: (clientY - rect.top) * scaleY
            };
        }

        function drawSymmetric(x, y) {
            const centerX = rangoliCanvas.width / 2;
            const centerY = rangoliCanvas.height / 2;
            
            for (let i = 0; i < SYMMETRY_POINTS; i++) {
                const angle = (i * 2 * Math.PI) / SYMMETRY_POINTS;
                
                const dx = x - centerX;
                const dy = y - centerY;
                
                const rotatedX = dx * Math.cos(angle) - dy * Math.sin(angle);
                const rotatedY = dx * Math.sin(angle) + dy * Math.cos(angle);
                
                rangoliCtx.beginPath();
                rangoliCtx.arc(centerX + rotatedX, centerY + rotatedY, currentBrushSize, 0, 2 * Math.PI);
                rangoliCtx.fillStyle = currentColor;
                rangoliCtx.fill();
                
                // Mirrored version for more complex patterns
                 const mirroredRotatedX = -dx * Math.cos(angle) - dy * Math.sin(angle);
                 rangoliCtx.beginPath();
                 rangoliCtx.arc(centerX + mirroredRotatedX, centerY + rotatedY, currentBrushSize, 0, 2 * Math.PI);
                 rangoliCtx.fillStyle = currentColor;
                 rangoliCtx.fill();
            }
        }

        function startDrawing(e) {
            isDrawing = true;
            draw(e);
        }

        function stopDrawing() {
            isDrawing = false;
            rangoliCtx.beginPath(); // Reset the path
        }
        
        function draw(e) {
            if (!isDrawing) return;
            e.preventDefault();
            const pos = getMousePos(rangoliCanvas, e);
            drawSymmetric(pos.x, pos.y);
        }

        rangoliCanvas.addEventListener('mousedown', startDrawing);
        rangoliCanvas.addEventListener('mousemove', draw);
        rangoliCanvas.addEventListener('mouseup', stopDrawing);
        rangoliCanvas.addEventListener('mouseout', stopDrawing);
        
        rangoliCanvas.addEventListener('touchstart', startDrawing);
        rangoliCanvas.addEventListener('touchmove', draw);
        rangoliCanvas.addEventListener('touchend', stopDrawing);

        colorPalette.addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON') {
                currentColor = e.target.style.backgroundColor;
                document.querySelector('.color-palette .active').classList.remove('active');
                e.target.classList.add('active');
            }
        });
        
        brushSizeInput.addEventListener('input', (e) => {
            currentBrushSize = e.target.value;
        });
        
        clearRangoliBtn.addEventListener('click', () => {
             rangoliCtx.fillStyle = '#111827';
             rangoliCtx.fillRect(0, 0, rangoliCanvas.width, rangoliCanvas.height);
        });

        // --- Sharing & Modal Logic ---
        const modal = document.getElementById('shareModal');
        const sharePreviewImage = document.getElementById('sharePreviewImage');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const friendNameInput = document.getElementById('friendName');
        const personalMessageInput = document.getElementById('personalMessage');
        const generateLinkBtn = document.getElementById('generateLinkBtn');
        const generatedLinkContainer = document.getElementById('generatedLinkContainer');
        const generatedLinkInput = document.getElementById('generatedLink');
        const copyLinkBtn = document.getElementById('copyLinkBtn');
        
        let currentCanvasToShare = null;

        function openShareModal(canvasEl) {
            currentCanvasToShare = canvasEl;
            const dataUrl = canvasEl.toDataURL('image/png');
            sharePreviewImage.src = dataUrl;
            
            // Reset modal state
            friendNameInput.value = '';
            personalMessageInput.value = '';
            generatedLinkContainer.classList.add('hidden');
            generatedLinkInput.value = '';

            modal.classList.remove('opacity-0', 'pointer-events-none');
            modal.querySelector('.modal-content').classList.remove('scale-95');
        }

        function closeModal() {
            modal.classList.add('opacity-0', 'pointer-events-none');
            modal.querySelector('.modal-content').classList.add('scale-95');
        }
        
        generateLinkBtn.addEventListener('click', () => {
            if (!currentCanvasToShare) return;

            const name = friendNameInput.value.trim();
            const message = personalMessageInput.value.trim();
            const imageData = currentCanvasToShare.toDataURL('image/png');

            if (!name || !message) {
                // A simple validation - changed from alert to a visual cue
                friendNameInput.classList.toggle('border-red-500', !name);
                personalMessageInput.classList.toggle('border-red-500', !message);
                return;
            }
            friendNameInput.classList.remove('border-red-500');
            personalMessageInput.classList.remove('border-red-500');


            const baseUrl = window.location.href.split('?')[0];
            const params = new URLSearchParams({
                name: btoa(name), // Base64 encode to handle special characters
                msg: btoa(message),
                img: imageData
            });

            const shareUrl = `${baseUrl}?${params.toString()}`;
            generatedLinkInput.value = shareUrl;
            generatedLinkContainer.classList.remove('hidden');
        });

        copyLinkBtn.addEventListener('click', () => {
            generatedLinkInput.select();
            document.execCommand('copy');
            copyLinkBtn.textContent = 'Copied!';
            setTimeout(() => {
                copyLinkBtn.textContent = 'Copy';
            }, 2000);
        });


        shareDiyaBtn.addEventListener('click', () => openShareModal(diyaCanvas));
        shareRangoliBtn.addEventListener('click', () => openShareModal(rangoliCanvas));
        closeModalBtn.addEventListener('click', closeModal);
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                closeModal();
            }
        });

        // --- Handle Incoming Shared Link ---
        function handleIncomingShare() {
            const params = new URLSearchParams(window.location.search);
            const name = params.get('name');
            const msg = params.get('msg');
            const img = params.get('img');

            if (name && msg && img) {
                document.getElementById('creator-view').classList.add('hidden');
                const greetingView = document.getElementById('greeting-view');
                
                try {
                    document.getElementById('greeting-for').textContent = `A special Diwali greeting for ${atob(name)}!`;
                    document.getElementById('greeting-message').textContent = `"${atob(msg)}"`;
                } catch (e) {
                     // Fallback if decoding fails
                    document.getElementById('greeting-for').textContent = `A special Diwali greeting for you!`;
                    document.getElementById('greeting-message').textContent = `Wishing you a happy Diwali!`;
                }
                document.getElementById('greeting-image').src = img;

                greetingView.classList.remove('hidden');
            } else {
                // If not a shared link, initialize the creator view
                resizeDiyaCanvas();
                resizeRangoliCanvas();
            }
        }


        // --- Initial Setup ---
        window.addEventListener('load', () => {
            handleIncomingShare();
        });
        window.addEventListener('resize', () => {
             // Only resize if creator view is active
            if (!document.getElementById('creator-view').classList.contains('hidden')) {
                resizeDiyaCanvas();
                resizeRangoliCanvas();
            }
        });

    </script>
</body>
</html>

